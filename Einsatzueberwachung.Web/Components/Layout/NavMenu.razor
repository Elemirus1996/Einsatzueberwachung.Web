@using Einsatzueberwachung.Domain.Interfaces
@using Einsatzueberwachung.Domain.Services
@inject ThemeService ThemeService
@inject IJSRuntime JS
@implements IDisposable

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="" aria-label="Zur Startseite">
            <i class="bi bi-alarm-fill text-danger" aria-hidden="true"></i> Einsatzüberwachung
        </a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column" aria-label="Hauptnavigation">
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="" Match="NavLinkMatch.All" aria-label="Zur Startseite">
                <span class="nav-icon"><i class="bi bi-house-fill" aria-hidden="true"></i></span> Home
            </NavLink>
        </div>

        <div class="nav-section-header" role="heading" aria-level="2">Einsatz</div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="einsatz/start" aria-label="Neuen Einsatz starten">
                <span class="nav-icon"><i class="bi bi-alarm-fill" aria-hidden="true"></i></span> Neuer Einsatz
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="einsatz/monitor" aria-label="Einsatz überwachen">
                <span class="nav-icon"><i class="bi bi-bar-chart-fill" aria-hidden="true"></i></span> Monitor
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="einsatz/karte" aria-label="Einsatzkarte anzeigen">
                <span class="nav-icon"><i class="bi bi-map-fill" aria-hidden="true"></i></span> Karte
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="einsatz/bericht" aria-label="Einsatzbericht erstellen">
                <span class="nav-icon"><i class="bi bi-file-text-fill" aria-hidden="true"></i></span> Bericht
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="mobile/connect" aria-label="Mobile App verbinden">
                <span class="nav-icon"><i class="bi bi-qr-code" aria-hidden="true"></i></span> Mobile QR-Code
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="archiv" aria-label="Einsatz-Archiv anzeigen">
                <span class="nav-icon"><i class="bi bi-archive-fill" aria-hidden="true"></i></span> Archiv
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="wetter" aria-label="Wetter und Flugwetter anzeigen">
                <span class="nav-icon"><i class="bi bi-cloud-sun-fill" aria-hidden="true"></i></span> Wetter
            </NavLink>
        </div>

        <div class="nav-section-header" role="heading" aria-level="2">Verwaltung</div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="stammdaten" aria-label="Stammdaten verwalten">
                <span class="nav-icon"><i class="bi bi-clipboard-data" aria-hidden="true"></i></span> Stammdaten
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="einstellungen" aria-label="Einstellungen öffnen">
                <span class="nav-icon"><i class="bi bi-gear-fill" aria-hidden="true"></i></span> Einstellungen
            </NavLink>
        </div>
    </nav>
</div>

@code {
    private bool _isDarkMode = false;
    private bool _isInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await ThemeService.InitializeAsync();
            _isDarkMode = ThemeService.IsDarkMode;
            _isInitialized = true;
            
            // Subscribe to theme changes
            ThemeService.OnThemeChanged += OnThemeChangedHandler;
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fehler bei Theme-Initialisierung: {ex.Message}");
        }
    }

    private async void OnThemeChangedHandler()
    {
        await InvokeAsync(() =>
        {
            _isDarkMode = ThemeService.IsDarkMode;
            StateHasChanged();
        });
    }

    private async Task ToggleTheme()
    {
        if (!_isInitialized)
        {
            Console.WriteLine("Theme-Service noch nicht initialisiert");
            return;
        }

        try
        {
            await ThemeService.ToggleThemeAsync();
            _isDarkMode = ThemeService.IsDarkMode;
            
            // Broadcast Theme-Änderung an alle Tabs/Fenster
            var theme = ThemeService.CurrentTheme;
            await JS.InvokeVoidAsync("broadcastThemeChange", theme);
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fehler beim Umschalten des Themes: {ex.Message}");
        }
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChangedHandler;
    }
}

