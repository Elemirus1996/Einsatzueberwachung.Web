@* Base Component für alle Seiten - Stellt Theme automatisch bereit *@
@using Einsatzueberwachung.Domain.Services
@using Microsoft.Extensions.Logging
@inject ThemeService ThemeService
@inject IJSRuntime JS
@inject ILogger<PageBase> Logger
@implements IDisposable

@code {
    protected override async Task OnInitializedAsync()
    {
        // Initialisiere Theme Service
        await ThemeService.InitializeAsync();
        
        // Subscribe to theme changes
        ThemeService.OnThemeChanged += OnThemeChanged;
        
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ApplyCurrentTheme();
        }
        
        await base.OnAfterRenderAsync(firstRender);
    }

    private async void OnThemeChanged()
    {
        await InvokeAsync(async () =>
        {
            await ApplyCurrentTheme();
            StateHasChanged();
        });
    }

    private async Task ApplyCurrentTheme()
    {
        try
        {
            var theme = ThemeService.CurrentTheme;
            await JS.InvokeVoidAsync("broadcastThemeChange", theme);
            Logger.LogDebug("Theme angewendet: {Theme}", theme);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fehler beim Anwenden des Themes");
        }
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }
}
