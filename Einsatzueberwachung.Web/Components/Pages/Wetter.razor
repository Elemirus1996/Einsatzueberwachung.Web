@page "/wetter"
@using Einsatzueberwachung.Domain.Interfaces
@inject IWeatherService WeatherService
@inject IEinsatzService EinsatzService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Wetter - DWD</PageTitle>

<div class="container-fluid">
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h1><i class="bi bi-cloud-sun me-2"></i>Wetter & Flugwetter</h1>
                <p class="text-muted">Daten vom Deutschen Wetterdienst (DWD)</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" @onclick="RefreshWeather" disabled="@_isLoading">
                    <i class="bi bi-arrow-clockwise @(_isLoading ? "spin" : "")"></i> Aktualisieren
                </button>
            </div>
        </div>
    </div>

    <!-- Standort-Auswahl -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Standort</label>
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Adresse oder Ort eingeben..."
                               @bind="_addressInput" @bind:event="oninput" @onkeypress="OnAddressKeyPress" />
                        <button class="btn btn-outline-primary" @onclick="SearchAddress">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Breitengrad</label>
                    <input type="number" step="0.0001" class="form-control" @bind="_latitude" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Laengengrad</label>
                    <input type="number" step="0.0001" class="form-control" @bind="_longitude" />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100" @onclick="LoadWeatherData" disabled="@_isLoading">
                        <i class="bi bi-cloud-download"></i> Wetter abrufen
                    </button>
                </div>
                <div class="col-md-2">
                    @if (EinsatzService.CurrentEinsatz.ElwPosition.HasValue)
                    {
                        <button class="btn btn-outline-info w-100" @onclick="UseElwPosition">
                            <i class="bi bi-geo-alt"></i> ELW-Position
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
            <p class="mt-3 text-muted">Wetterdaten werden abgerufen...</p>
        </div>
    }
    else if (_error != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Fehler:</strong> @_error
        </div>
    }
    else if (_weatherData != null)
    {
        <div class="row">
            <!-- Aktuelles Wetter -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-thermometer-half me-2"></i>Aktuelles Wetter</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-4">
                            <div class="me-4">
                                <i class="bi @_weatherData.GetBootstrapIcon() display-1" style="color: var(--bs-primary);"></i>
                            </div>
                            <div>
                                <div class="display-4 fw-bold">@_weatherData.TemperaturFormatiert</div>
                                <div class="text-muted fs-5">@_weatherData.Wetterlage</div>
                                @if (Math.Abs(_weatherData.GefuehlteTemperatur - _weatherData.Temperatur) > 2)
                                {
                                    <small class="text-muted">Gefuehlt: @_weatherData.GefuehlteTemperatur.ToString("F1")°C</small>
                                }
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <i class="bi bi-wind fs-4 text-info"></i>
                                    <div class="fw-bold">@_weatherData.WindFormatiert</div>
                                    <small class="text-muted">Wind</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <i class="bi bi-droplet fs-4 text-primary"></i>
                                    <div class="fw-bold">@_weatherData.LuftfeuchtigkeitFormatiert</div>
                                    <small class="text-muted">Luftfeuchtigkeit</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <i class="bi bi-cloud-rain fs-4 text-info"></i>
                                    <div class="fw-bold">@_weatherData.Niederschlag.ToString("F1") mm</div>
                                    <small class="text-muted">Niederschlag/h</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <i class="bi bi-speedometer2 fs-4 text-secondary"></i>
                                    <div class="fw-bold">@_weatherData.Luftdruck.ToString("F0") hPa</div>
                                    <small class="text-muted">Luftdruck</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <i class="bi bi-clouds fs-4 text-secondary"></i>
                                    <div class="fw-bold">@_weatherData.Bewoelkung%</div>
                                    <small class="text-muted">Bewoelkung</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <i class="bi bi-eye fs-4 @(_weatherData.Sichtweite < 5 ? "text-warning" : "text-success")"></i>
                                    <div class="fw-bold">@FormatSichtweite(_weatherData.Sichtweite)</div>
                                    <small class="text-muted">Sichtweite</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-muted small d-flex justify-content-between align-items-center">
                        <span>Aktualisiert: @_weatherData.Zeitpunkt.ToString("dd.MM.yyyy HH:mm") Uhr</span>
                        <span class="badge bg-secondary">
                            <i class="bi bi-arrow-repeat me-1"></i>Auto-Refresh: 10 Min
                        </span>
                    </div>
                </div>
            </div>

            <!-- Flugwetter -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-airplane me-2"></i>Flugwetter (Drohnen)</h5>
                        @if (_flugwetterData != null)
                        {
                            <span class="badge @_flugwetterData.GetKategorieBadgeClass() fs-6">
                                @_flugwetterData.Kategorie
                            </span>
                        }
                    </div>
                    <div class="card-body">
                        @if (_flugwetterData != null)
                        {
                            <!-- Flugkategorie-Anzeige -->
                            <div class="alert @(_flugwetterData.IstDrohnenflugMoeglich ? "alert-success" : "alert-danger") mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi @(_flugwetterData.IstDrohnenflugMoeglich ? "bi-check-circle-fill" : "bi-x-circle-fill") fs-1 me-3"></i>
                                    <div>
                                        <h4 class="mb-1">@_flugwetterData.GetKategorieText()</h4>
                                        <p class="mb-0">@_flugwetterData.DrohnenflugHinweis</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Station Info -->
                            <div class="small text-muted mb-3">
                                <i class="bi bi-broadcast me-1"></i>Station: @_flugwetterData.StationsName
                            </div>
                        }
                        else
                        {
                            var flugwetter = GetFlugwetterBewertung();
                            
                            <div class="alert @flugwetter.AlertClass mb-4">
                                <div class="d-flex align-items-center">
                                    <i class="bi @flugwetter.Icon fs-1 me-3"></i>
                                    <div>
                                        <h4 class="mb-1">@flugwetter.Status</h4>
                                        <p class="mb-0">@flugwetter.Beschreibung</p>
                                    </div>
                                </div>
                            </div>
                        }

                        <h6 class="mb-3">Flugbedingungen im Detail:</h6>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td><i class="bi bi-wind me-2"></i>Windgeschwindigkeit</td>
                                    <td class="fw-bold">@_weatherData.Windgeschwindigkeit.ToString("F0") km/h</td>
                                    <td>
                                        @if (_weatherData.Windgeschwindigkeit < 20)
                                        {
                                            <span class="badge bg-success">Gut</span>
                                        }
                                        else if (_weatherData.Windgeschwindigkeit < 35)
                                        {
                                            <span class="badge bg-warning text-dark">Maessig</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">Kritisch</span>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-arrow-up-right me-2"></i>Windboeen</td>
                                    <td class="fw-bold">@(_windGusts?.ToString("F0") ?? "-") km/h</td>
                                    <td>
                                        @if (!_windGusts.HasValue || _windGusts < 30)
                                        {
                                            <span class="badge bg-success">Gut</span>
                                        }
                                        else if (_windGusts < 50)
                                        {
                                            <span class="badge bg-warning text-dark">Maessig</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">Kritisch</span>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-eye me-2"></i>Sichtweite</td>
                                    <td class="fw-bold">@FormatSichtweite(_weatherData.Sichtweite)</td>
                                    <td>
                                        @if (_weatherData.Sichtweite >= 5)
                                        {
                                            <span class="badge bg-success">Gut</span>
                                        }
                                        else if (_weatherData.Sichtweite >= 1)
                                        {
                                            <span class="badge bg-warning text-dark">Eingeschraenkt</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">Kritisch</span>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-cloud-rain me-2"></i>Niederschlag</td>
                                    <td class="fw-bold">@_weatherData.Niederschlag.ToString("F1") mm/h</td>
                                    <td>
                                        @if (_weatherData.Niederschlag < 0.5)
                                        {
                                            <span class="badge bg-success">Kein</span>
                                        }
                                        else if (_weatherData.Niederschlag < 2.5)
                                        {
                                            <span class="badge bg-warning text-dark">Leicht</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">Stark</span>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-clouds me-2"></i>Wolkenuntergrenze</td>
                                    <td class="fw-bold">@(_cloudBase?.ToString("F0") ?? ">2000") m</td>
                                    <td>
                                        @if (!_cloudBase.HasValue || _cloudBase > 150)
                                        {
                                            <span class="badge bg-success">Gut</span>
                                        }
                                        else if (_cloudBase > 50)
                                        {
                                            <span class="badge bg-warning text-dark">Niedrig</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">Sehr niedrig</span>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-thermometer me-2"></i>Temperatur</td>
                                    <td class="fw-bold">@_weatherData.Temperatur.ToString("F1")°C</td>
                                    <td>
                                        @if (_weatherData.Temperatur > 0 && _weatherData.Temperatur < 40)
                                        {
                                            <span class="badge bg-success">OK</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">Grenzwertig</span>
                                        }
                                    </td>
                                </tr>
                                @if (_flugwetterData != null)
                                {
                                    <tr>
                                        <td><i class="bi bi-speedometer2 me-2"></i>QNH</td>
                                        <td class="fw-bold">@_flugwetterData.QNH hPa</td>
                                        <td>
                                            @if (_flugwetterData.QNH > 1000 && _flugwetterData.QNH < 1030)
                                            {
                                                <span class="badge bg-success">Normal</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-info">Abweichend</span>
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><i class="bi bi-droplet me-2"></i>Spread (T-Td)</td>
                                        <td class="fw-bold">@_flugwetterData.Spread.ToString("F1")°C</td>
                                        <td>
                                            @if (_flugwetterData.Spread > 5)
                                            {
                                                <span class="badge bg-success">Gut</span>
                                            }
                                            else if (_flugwetterData.Spread > 2)
                                            {
                                                <span class="badge bg-warning text-dark">Vorsicht</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Nebel möglich</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                        @if (_flugwetterData?.MetarRaw != null)
                        {
                            <div class="card bg-dark text-light mt-3">
                                <div class="card-body py-2">
                                    <small class="text-muted">METAR (berechnet):</small>
                                    <code class="d-block text-light small">@_flugwetterData.MetarRaw</code>
                                </div>
                            </div>
                        }

                        <div class="alert alert-info small mt-3">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Hinweis:</strong> Drohnenflug nur bei Sichtweite &gt; 1 km, Wind &lt; 35 km/h, 
                            kein Niederschlag und Wolkenuntergrenze &gt; 50 m empfohlen.
                            @if (_flugwetterData != null)
                            {
                                <br/><small>Daten basierend auf DWD Open Data via BrightSky API.</small>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DWD Warnungen -->
        @if (_weatherData.HatWarnung)
        {
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>DWD Wetterwarnungen</h5>
                </div>
                <div class="card-body">
                    <div class="alert @_weatherData.GetWarnungBadgeClass().Replace("bg-", "alert-")">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        @_weatherData.Warnung
                    </div>
                </div>
            </div>
        }

        <!-- Vorhersage -->
        @if (_forecast != null && _forecast.StundenVorhersage.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Stundenvorhersage</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm text-center">
                            <thead>
                                <tr>
                                    @foreach (var hour in _forecast.StundenVorhersage.Take(12))
                                    {
                                        <th>@hour.Zeitpunkt.ToString("HH:mm")</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    @foreach (var hour in _forecast.StundenVorhersage.Take(12))
                                    {
                                        <td><i class="bi @hour.GetBootstrapIcon() fs-4"></i></td>
                                    }
                                </tr>
                                <tr>
                                    @foreach (var hour in _forecast.StundenVorhersage.Take(12))
                                    {
                                        <td class="fw-bold">@hour.Temperatur.ToString("F0")°</td>
                                    }
                                </tr>
                                <tr class="text-muted small">
                                    @foreach (var hour in _forecast.StundenVorhersage.Take(12))
                                    {
                                        <td>@hour.Windgeschwindigkeit.ToString("F0") km/h</td>
                                    }
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Standort eingeben:</strong> Geben Sie oben eine Adresse oder Koordinaten ein, um Wetterdaten abzurufen.
            @if (EinsatzService.CurrentEinsatz.ElwPosition.HasValue)
            {
                <br /><br />
                <button class="btn btn-info btn-sm" @onclick="UseElwPosition">
                    <i class="bi bi-geo-alt me-1"></i>ELW-Position verwenden
                </button>
            }
        </div>
    }
</div>

<style>
    .spin {
        animation: spin 1s linear infinite;
    }
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

@code {
    private double _latitude = 51.1657;  // Deutschland Mitte
    private double _longitude = 10.4515;
    private string _addressInput = "";
    
    private WeatherData? _weatherData;
    private WeatherForecast? _forecast;
    private FlugwetterData? _flugwetterData;
    private double? _windGusts;
    private double? _cloudBase;
    
    private bool _isLoading = false;
    private string? _error;
    
    private System.Timers.Timer? _refreshTimer;
    private DateTime? _lastRefresh;

    protected override async Task OnInitializedAsync()
    {
        // Wenn ELW-Position vorhanden, automatisch laden
        if (EinsatzService.CurrentEinsatz.ElwPosition.HasValue)
        {
            UseElwPosition();
            await LoadWeatherData();
        }
        
        // Auto-Refresh alle 10 Minuten
        _refreshTimer = new System.Timers.Timer(10 * 60 * 1000); // 10 Minuten
        _refreshTimer.AutoReset = true; // Wiederholt automatisch
        _refreshTimer.Elapsed += async (s, e) =>
        {
            if (_weatherData != null)
            {
                await InvokeAsync(async () =>
                {
                    await LoadWeatherData();
                    _lastRefresh = DateTime.Now;
                    StateHasChanged();
                });
            }
        };
        _refreshTimer.Start();
    }

    private void UseElwPosition()
    {
        if (EinsatzService.CurrentEinsatz.ElwPosition.HasValue)
        {
            var pos = EinsatzService.CurrentEinsatz.ElwPosition.Value;
            _latitude = pos.Latitude;
            _longitude = pos.Longitude;
            _addressInput = "ELW-Position";
        }
    }

    private async Task OnAddressKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchAddress();
        }
    }

    private async Task SearchAddress()
    {
        if (string.IsNullOrWhiteSpace(_addressInput)) return;

        _isLoading = true;
        _error = null;

        try
        {
            // Nominatim Geocoding API
            using var http = new HttpClient();
            http.DefaultRequestHeaders.Add("User-Agent", "Einsatzueberwachung/3.8");
            
            var url = $"https://nominatim.openstreetmap.org/search?q={Uri.EscapeDataString(_addressInput)}&format=json&limit=1&countrycodes=de";
            var response = await http.GetStringAsync(url);
            
            var results = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement[]>(response);
            if (results != null && results.Length > 0)
            {
                _latitude = double.Parse(results[0].GetProperty("lat").GetString()!, System.Globalization.CultureInfo.InvariantCulture);
                _longitude = double.Parse(results[0].GetProperty("lon").GetString()!, System.Globalization.CultureInfo.InvariantCulture);
                
                await LoadWeatherData();
            }
            else
            {
                _error = "Adresse nicht gefunden. Bitte versuchen Sie es mit einer anderen Eingabe.";
            }
        }
        catch (Exception ex)
        {
            _error = $"Fehler bei der Adresssuche: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadWeatherData()
    {
        _isLoading = true;
        _error = null;

        try
        {
            _weatherData = await WeatherService.GetCurrentWeatherAsync(_latitude, _longitude);
            _forecast = await WeatherService.GetForecastAsync(_latitude, _longitude);
            
            // Flugwetter-Daten vom Service abrufen (mit Kategorieberechnung)
            _flugwetterData = await WeatherService.GetFlugwetterAsync(_latitude, _longitude);
            
            // Fallback auf berechnete Werte, wenn FlugwetterData verfügbar
            if (_flugwetterData != null)
            {
                _windGusts = _flugwetterData.Windboeen;
                _cloudBase = _flugwetterData.Wolkenuntergrenze;
            }
            else if (_weatherData != null)
            {
                // Echte Boeen-Daten von der API verwenden
                _windGusts = _weatherData.Windboeen > 0 ? _weatherData.Windboeen : _weatherData.Windgeschwindigkeit * 1.3;
                
                // Wolkenuntergrenze basierend auf Bewoelkung und Taupunkt schaetzen
                // Bei hoher Bewoelkung und niedrigem Spread (Temperatur - Taupunkt) niedrige Wolken
                var spread = _weatherData.Temperatur - _weatherData.Taupunkt;
                if (_weatherData.Bewoelkung > 80)
                {
                    // Faustformel: Wolkenuntergrenze ~ 125m pro 1°C Spread
                    _cloudBase = Math.Max(100, (int)(spread * 125));
                }
                else if (_weatherData.Bewoelkung > 50)
                {
                    _cloudBase = Math.Max(300, (int)(spread * 125));
                }
                else if (_weatherData.Bewoelkung > 20)
                {
                    _cloudBase = Math.Max(800, (int)(spread * 125));
                }
                else
                {
                    _cloudBase = null; // Weitgehend wolkenfrei
                }
            }
        }
        catch (Exception ex)
        {
            _error = $"Fehler beim Laden der Wetterdaten: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshWeather()
    {
        await LoadWeatherData();
    }

    private string FormatSichtweite(double km)
    {
        if (km >= 10) return ">10 km";
        if (km >= 1) return $"{km:F1} km";
        return $"{(km * 1000):F0} m";
    }

    private (string Status, string Beschreibung, string AlertClass, string Icon) GetFlugwetterBewertung()
    {
        if (_weatherData == null)
            return ("Unbekannt", "Keine Daten verfuegbar", "alert-secondary", "bi-question-circle");

        int score = 0;
        var probleme = new List<string>();

        // Wind
        if (_weatherData.Windgeschwindigkeit < 20) score += 2;
        else if (_weatherData.Windgeschwindigkeit < 35) score += 1;
        else probleme.Add("starker Wind");

        // Windboeen
        if (!_windGusts.HasValue || _windGusts < 30) score += 2;
        else if (_windGusts < 50) score += 1;
        else probleme.Add("starke Boeen");

        // Sichtweite
        if (_weatherData.Sichtweite >= 5) score += 2;
        else if (_weatherData.Sichtweite >= 1) score += 1;
        else probleme.Add("schlechte Sicht");

        // Niederschlag
        if (_weatherData.Niederschlag < 0.5) score += 2;
        else if (_weatherData.Niederschlag < 2.5) score += 1;
        else probleme.Add("Niederschlag");

        // Wolkenuntergrenze
        if (!_cloudBase.HasValue || _cloudBase > 150) score += 2;
        else if (_cloudBase > 50) score += 1;
        else probleme.Add("tiefe Wolken");

        if (score >= 9)
            return ("Sehr gute Flugbedingungen", "Ideale Bedingungen fuer Drohnenflug", "alert-success", "bi-check-circle-fill");
        if (score >= 7)
            return ("Gute Flugbedingungen", "Drohnenflug moeglich mit Vorsicht", "alert-success", "bi-check-circle");
        if (score >= 5)
            return ("Maessige Flugbedingungen", $"Einschraenkungen: {string.Join(", ", probleme)}", "alert-warning", "bi-exclamation-triangle");
        
        return ("Schlechte Flugbedingungen", $"Drohnenflug nicht empfohlen: {string.Join(", ", probleme)}", "alert-danger", "bi-x-circle-fill");
    }

    public void Dispose()
    {
        _refreshTimer?.Stop();
        _refreshTimer?.Dispose();
    }
}
