@page "/einsatz/monitor"
@using Einsatzueberwachung.Domain.Services
@using Einsatzueberwachung.Domain.Interfaces
@using Einsatzueberwachung.Web.Components.Widgets
@inject IEinsatzService EinsatzService
@inject IMasterDataService MasterDataService
@inject IArchivService ArchivService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ToastService ToastService
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Einsatzmonitor</PageTitle>

<div class="monitor-container-classic">
    <div class="page-header">
        <div>
            <h1>Einsatzmonitor - Live</h1>
            <p class="text-muted">
                @EinsatzService.CurrentEinsatz.EinsatzTyp: @EinsatzService.CurrentEinsatz.Einsatzort
                <br/>
                Datum: @EinsatzService.CurrentEinsatz.EinsatzDatum.ToString("dd.MM.yyyy HH:mm")
            </p>
        </div>
        <div class="d-flex align-items-start gap-3">
            @if (EinsatzService.CurrentEinsatz.ElwLatitude.HasValue && EinsatzService.CurrentEinsatz.ElwLongitude.HasValue)
            {
                <div class="wetter-container" style="min-width: 200px;">
                    <WetterWidget Latitude="EinsatzService.CurrentEinsatz.ElwLatitude" 
                                  Longitude="EinsatzService.CurrentEinsatz.ElwLongitude" 
                                  RefreshIntervalMinutes="10" />
                </div>
            }
            else
            {
                <div class="text-muted small" style="min-width: 200px;">
                    <i class="bi bi-cloud me-1"></i>Wetter: ELW-Position auf Karte setzen
                </div>
            }
            <div class="btn-group-vertical">
                <button class="btn btn-info btn-lg" @onclick="GoToMap">
                    <i class="bi bi-map me-1"></i>Karte
                </button>
                <button class="btn btn-primary btn-lg" @onclick="GoToReport">
                    <i class="bi bi-file-text me-1"></i>Bericht
                </button>
                <button class="btn btn-danger btn-lg" @onclick="ShowEndEinsatzDialog">
                    <i class="bi bi-stop-circle me-1"></i>Beenden
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>Teams (@_teams.Count)</h4>
                    <button class="btn btn-success" @onclick="ShowAddTeamDialog">
                        + Team hinzufügen
                    </button>
                </div>
                <div class="card-body">
                    @if (_teams.Any())
                    {
                        <div class="teams-monitor-list">
                            @foreach (var team in _teams)
                            {
                                <div class="monitor-team-card @(team.IsRunning ? "team-running" : "") @(team.IsSecondWarning ? "team-critical" : team.IsFirstWarning ? "team-warning" : "")">
                                    <div class="team-info" style="border-left: 5px solid @GetTeamColor(team);">
                                        <div class="team-name-section">
                                            <h5>@team.TeamName</h5>
                                            @if (!string.IsNullOrEmpty(team.DogName))
                                            {
                                                <span class="team-dog">Hund: @team.DogName</span>
                                            }
                                            @if (team.IsDroneTeam && !string.IsNullOrEmpty(team.DroneType))
                                            {
                                                <span class="team-dog">Drohne: @team.DroneType</span>
                                            }
                                            @if (!string.IsNullOrEmpty(team.HundefuehrerName))
                                            {
                                                <span class="team-member">@team.HundefuehrerName</span>
                                            }
                                            @if (!string.IsNullOrEmpty(team.HelferName))
                                            {
                                                <span class="team-member">@team.HelferName (Helfer)</span>
                                            }
                                            @if (!string.IsNullOrEmpty(team.SearchAreaName))
                                            {
                                                <span class="team-area">Gebiet: @team.SearchAreaName</span>
                                            }
                                        </div>
                                        <div class="team-timer">
                                            @if (!team.IsDroneTeam && !team.IsSupportTeam)
                                            {
                                                <div class="timer-display @(team.IsSecondWarning ? "timer-critical" : team.IsFirstWarning ? "timer-warning" : "")">
                                                    @FormatTimeSpan(team.ElapsedTime)
                                                </div>
                                                @if (team.IsSecondWarning)
                                                {
                                                    <span class="warning-badge badge bg-danger">KRITISCH</span>
                                                }
                                                else if (team.IsFirstWarning)
                                                {
                                                    <span class="warning-badge badge bg-warning">Warnung</span>
                                                }
                                            }
                                            else
                                            {
                                                <small class="text-muted">Kein Timer erforderlich</small>
                                            }
                                        </div>
                                        <div class="team-controls">
                                            @if (!team.IsDroneTeam && !team.IsSupportTeam)
                                            {
                                                @if (team.IsRunning)
                                                {
                                                    <button class="btn btn-warning" @onclick="() => StopTeam(team.TeamId)">
                                                        Stop
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-success" @onclick="() => StartTeam(team.TeamId)">
                                                        Start
                                                    </button>
                                                }
                                                <button class="btn btn-secondary" @onclick="() => ResetTeam(team.TeamId)">
                                                    Reset
                                                </button>
                                            }
                                            <button class="btn btn-sm btn-primary" @onclick="() => EditTeam(team)">
                                                Bearbeiten
                                            </button>
                                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteTeam(team)">
                                                Löschen
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            Noch keine Teams vorhanden. Klicken Sie auf "Team hinzufügen".
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h4><i class="bi bi-chat-left-text-fill"></i> Notizen & Funksprüche</h4>
                </div>
                <div class="card-body">
                    <!-- Neue Notiz mit Team-Auswahl -->
                    <div class="note-input-section mb-3">
                        <div class="mb-2">
                            <label class="form-label fw-bold">Team/Quelle *</label>
                            <select class="form-select" @bind="_selectedNoteTeamId">
                                <option value="">-- Team wählen (Pflicht) --</option>
                                @foreach (var team in _teams)
                                {
                                    <option value="@team.TeamId">@team.TeamName</option>
                                }
                                <option value="einsatzleitung">Einsatzleitung</option>
                            </select>
                        </div>
                        <textarea class="form-control mb-2" 
                                  rows="3" 
                                  @bind="_newNoteText" 
                                  placeholder="Neuer Funkspruch oder Notiz..."></textarea>
                        <button class="btn btn-primary w-100" 
                                @onclick="AddNote"
                                disabled="@(string.IsNullOrEmpty(_selectedNoteTeamId) || string.IsNullOrWhiteSpace(_newNoteText))">
                            <i class="bi bi-send-fill"></i> Hinzufügen
                        </button>
                    </div>

                    <!-- NotesEnhanced Komponente -->
                    <div class="notes-list" style="max-height: 600px; overflow-y: auto;">
                        <NotesEnhanced 
                            Notes="@_notes" 
                            AvailableTeams="@_teams"
                            AllowEdit="true"
                            OnNotesChanged="RefreshNotes" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Einsatz beenden Dialog -->
@if (_showEndDialog)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-stop-circle me-2"></i>Einsatz beenden und archivieren</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseEndEinsatzDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Achtung:</strong> Nach dem Beenden wird der Einsatz archiviert und alle Teams werden zurueckgesetzt.
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Ergebnis</label>
                            <select class="form-select" @bind="_endErgebnis">
                                <option value="">-- Bitte waehlen --</option>
                                <option value="Person gefunden - lebend">Person gefunden - lebend</option>
                                <option value="Person gefunden - verstorben">Person gefunden - verstorben</option>
                                <option value="Person anderweitig gefunden">Person anderweitig gefunden</option>
                                <option value="Abbruch - Wetter">Abbruch - Wetter</option>
                                <option value="Abbruch - Dunkelheit">Abbruch - Dunkelheit</option>
                                <option value="Suche erfolglos abgeschlossen">Suche erfolglos abgeschlossen</option>
                                <option value="Uebung abgeschlossen">Uebung abgeschlossen</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Ende-Zeit</label>
                            <input type="time" class="form-control" @bind="_endZeit" />
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Bemerkungen</label>
                        <textarea class="form-control" rows="3" @bind="_endBemerkungen" 
                                  placeholder="Zusaetzliche Informationen zum Einsatzabschluss..."></textarea>
                    </div>
                    
                    <div class="bg-light p-3 rounded">
                        <h6>Einsatz-Zusammenfassung</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted">Teams:</small>
                                <div class="fw-bold">@_teams.Count</div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Personal:</small>
                                <div class="fw-bold">@_teams.Sum(t => (string.IsNullOrEmpty(t.HundefuehrerName) ? 0 : 1) + (string.IsNullOrEmpty(t.HelferName) ? 0 : 1))</div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Hunde:</small>
                                <div class="fw-bold">@_teams.Count(t => !string.IsNullOrEmpty(t.DogName))</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseEndEinsatzDialog">Abbrechen</button>
                    <button class="btn btn-danger" @onclick="EndEinsatzConfirmed" disabled="@string.IsNullOrEmpty(_endErgebnis)">
                        <i class="bi bi-archive me-1"></i>Einsatz beenden & archivieren
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<TeamDialog 
IsVisible="@_showDialog"
IsEdit="@(_editingTeam != null)"
Team="@_currentTeam"
PersonalList="@_personalList"
DogList="@_dogList"
DroneList="@_droneList"
OnSave="SaveTeam"
OnCancel="CloseDialog"
OnDogChanged="OnDogSelected"
OnDroneChanged="OnDroneSelected"
OnHundefuehrerChanged="OnHundefuehrerSelected"
OnHelferChanged="OnHelferSelected"
OnTeamTypeChanged="UpdateTeamName" />

@code {
    private List<Team> _teams = new();
    private List<GlobalNotesEntry> _notes = new();
    private List<PersonalEntry> _personalList = new();
    private List<DogEntry> _dogList = new();
    private List<DroneEntry> _droneList = new();
    private string _newNoteText = "";
    private string _selectedNoteTeamId = "";
    private System.Threading.Timer? _refreshTimer;
    
    private bool _showDialog = false;
    private Team _currentTeam = new();
    private Team? _editingTeam = null;
    
    // Einsatz beenden Dialog
    private bool _showEndDialog = false;
    private string _endErgebnis = "";
    private string _endBemerkungen = "";
    private TimeOnly _endZeit = TimeOnly.FromDateTime(DateTime.Now);

    protected override async Task OnInitializedAsync()
    {
        _personalList = await MasterDataService.GetPersonalListAsync();
        _dogList = await MasterDataService.GetDogListAsync();
        _droneList = await MasterDataService.GetDroneListAsync();
        
        _teams = EinsatzService.Teams;
        _notes = EinsatzService.GlobalNotes;
        
        // MIGRATION: Alte Notizen kompatibel machen
        MigrateOldNotes();

        EinsatzService.TeamAdded += OnDataChanged;
        EinsatzService.TeamRemoved += OnDataChanged;
        EinsatzService.TeamUpdated += OnDataChanged;
        EinsatzService.NoteAdded += OnDataChanged;
        EinsatzService.TeamWarningTriggered += OnWarningTriggered;
        EinsatzService.EinsatzChanged += OnEinsatzChanged;

        foreach (var team in _teams)
        {
            team.TimerTick += OnTimerTick;
        }

        _refreshTimer = new System.Threading.Timer(_ => InvokeAsync(StateHasChanged), null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }
    
    private void MigrateOldNotes()
    {
        // F�ge fehlende Felder zu alten Notizen hinzu
        foreach (var note in _notes)
        {
            if (string.IsNullOrEmpty(note.SourceTeamId) && !string.IsNullOrEmpty(note.SourceTeamName))
            {
                // Alte Notiz ohne SourceTeamId - setze default
                note.SourceTeamId = "unknown";
                note.SourceType = "Legacy";
            }
            
            if (string.IsNullOrEmpty(note.SourceTeamName))
            {
                note.SourceTeamName = "Unbekannt";
                note.SourceTeamId = "unknown";
                note.SourceType = "System";
            }
            
            if (string.IsNullOrEmpty(note.CreatedBy))
            {
                note.CreatedBy = "System";
            }
            
            if (note.Replies == null)
            {
                note.Replies = new List<GlobalNotesReply>();
            }
        }
    }

    private void ShowAddTeamDialog()
    {
        _editingTeam = null;
        _currentTeam = new Team 
        { 
            FirstWarningMinutes = 45,
            SecondWarningMinutes = 60
        };
        _showDialog = true;
    }

    private void EditTeam(Team team)
    {
        _editingTeam = team;
        _currentTeam = new Team
        {
            TeamId = team.TeamId,
            TeamName = team.TeamName,
            DogId = team.DogId,
            DogName = team.DogName,
            DogSpecialization = team.DogSpecialization,
            HundefuehrerId = team.HundefuehrerId,
            HundefuehrerName = team.HundefuehrerName,
            HelferId = team.HelferId,
            HelferName = team.HelferName,
            IsDroneTeam = team.IsDroneTeam,
            DroneType = team.DroneType,
            DroneId = team.DroneId,
            IsSupportTeam = team.IsSupportTeam,
            Notes = team.Notes,
            FirstWarningMinutes = team.FirstWarningMinutes,
            SecondWarningMinutes = team.SecondWarningMinutes
        };
        _showDialog = true;
    }

    private async Task SaveTeam()
    {
        try
        {
            if (_editingTeam != null)
            {
                await EinsatzService.UpdateTeamAsync(_currentTeam);
                ToastService.ShowSuccess($"Team '{_currentTeam.TeamName}' wurde aktualisiert");
            }
            else
            {
                await EinsatzService.AddTeamAsync(_currentTeam);
                ToastService.ShowSuccess($"Team '{_currentTeam.TeamName}' wurde erstellt");
            }
            CloseDialog();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Fehler beim Speichern: {ex.Message}");
        }
    }

    private async Task DeleteTeam(Team team)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Team '{team.TeamName}' wirklich l�schen?"))
        {
            await EinsatzService.RemoveTeamAsync(team.TeamId);
            ToastService.ShowSuccess($"Team '{team.TeamName}' wurde gel�scht");
        }
    }

    private void CloseDialog()
    {
        _showDialog = false;
        _editingTeam = null;
    }

    private void OnDogSelected()
    {
        if (!string.IsNullOrEmpty(_currentTeam.DogId))
        {
            var dog = _dogList.FirstOrDefault(d => d.Id == _currentTeam.DogId);
            if (dog != null)
            {
                _currentTeam.DogName = dog.Name;
                _currentTeam.DogSpecialization = dog.Specializations;
                UpdateTeamName();
            }
        }
    }

    private void OnDroneSelected()
    {
        if (!string.IsNullOrEmpty(_currentTeam.DroneId))
        {
            var drone = _droneList.FirstOrDefault(d => d.Id == _currentTeam.DroneId);
            if (drone != null)
            {
                _currentTeam.DroneType = drone.FullDescription;
                UpdateTeamName();
            }
        }
    }

    private void OnHundefuehrerSelected()
    {
        if (!string.IsNullOrEmpty(_currentTeam.HundefuehrerId))
        {
            var person = _personalList.FirstOrDefault(p => p.Id == _currentTeam.HundefuehrerId);
            if (person != null)
            {
                _currentTeam.HundefuehrerName = person.FullName;
            }
        }
    }

    private void OnHelferSelected()
    {
        if (!string.IsNullOrEmpty(_currentTeam.HelferId))
        {
            var person = _personalList.FirstOrDefault(p => p.Id == _currentTeam.HelferId);
            if (person != null)
            {
                _currentTeam.HelferName = person.FullName;
            }
        }
    }

    private void UpdateTeamName()
    {
        if (_currentTeam.IsDroneTeam && !string.IsNullOrEmpty(_currentTeam.DroneId))
        {
            var drone = _droneList.FirstOrDefault(d => d.Id == _currentTeam.DroneId);
            if (drone != null)
            {
                _currentTeam.TeamName = $"Team {drone.DisplayName}";
            }
        }
        else if (!_currentTeam.IsDroneTeam && !_currentTeam.IsSupportTeam && !string.IsNullOrEmpty(_currentTeam.DogId))
        {
            var dog = _dogList.FirstOrDefault(d => d.Id == _currentTeam.DogId);
            if (dog != null)
            {
                _currentTeam.TeamName = $"Team {dog.Name}";
            }
        }
        else if (_currentTeam.IsSupportTeam)
        {
            _currentTeam.TeamName = $"Support-Team {_teams.Count(t => t.IsSupportTeam) + 1}";
        }
        else
        {
            _currentTeam.TeamName = $"Team {_teams.Count + 1}";
        }
    }

    private async Task StartTeam(string teamId)
    {
        await EinsatzService.StartTeamTimerAsync(teamId);
    }

    private async Task StopTeam(string teamId)
    {
        await EinsatzService.StopTeamTimerAsync(teamId);
    }

    private async Task ResetTeam(string teamId)
    {
        await EinsatzService.ResetTeamTimerAsync(teamId);
    }

    private async Task AddNote()
    {
        if (string.IsNullOrWhiteSpace(_newNoteText) || string.IsNullOrEmpty(_selectedNoteTeamId))
        {
            return;
        }

        try
        {
            string teamName = "Unbekannt";
            string teamType = "Manual";
            
            if (_selectedNoteTeamId == "einsatzleitung")
            {
                teamName = "Einsatzleitung";
                teamType = "Einsatzleitung";
            }
            else
            {
                var team = _teams.FirstOrDefault(t => t.TeamId == _selectedNoteTeamId);
                if (team != null)
                {
                    teamName = team.TeamName;
                    teamType = team.IsDroneTeam ? "Drohnen-Team" : team.IsSupportTeam ? "Support-Team" : "Hunde-Team";
                }
            }

            await EinsatzService.AddGlobalNoteWithSourceAsync(
                text: _newNoteText,
                sourceTeamId: _selectedNoteTeamId,
                sourceTeamName: teamName,
                sourceType: teamType,
                type: GlobalNotesEntryType.Manual,
                createdBy: "User"
            );

            _newNoteText = "";
            _selectedNoteTeamId = "";
            await RefreshNotes();
            ToastService.ShowSuccess("Notiz wurde hinzugef�gt");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fehler beim Erstellen der Notiz: {ex.Message}");
            ToastService.ShowError("Fehler beim Hinzuf�gen der Notiz");
        }
    }
    
    private async Task RefreshNotes()
    {
        _notes = await EinsatzService.GetFilteredNotesAsync();
        StateHasChanged();
    }

    private string FormatTimeSpan(TimeSpan ts)
    {
        return $"{(int)ts.TotalHours:D2}:{ts.Minutes:D2}:{ts.Seconds:D2}";
    }

    private string GetTeamColor(Team team)
    {
        if (team.IsDroneTeam) return "#00BCD4";
        if (team.IsSupportTeam) return "#9E9E9E";
        return team.DogSpecialization.GetColorHex();
    }

    private void OnDataChanged(Team team)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnDataChanged(GlobalNotesEntry note)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnTimerTick(Team team)
    {
        InvokeAsync(StateHasChanged);
    }

    private async void OnWarningTriggered(Team team, bool isSecondWarning)
    {
        await InvokeAsync(async () =>
        {
            try
            {
                // Akustische Warnung abspielen
                if (isSecondWarning)
                {
                    await JSRuntime.InvokeVoidAsync("AudioAlerts.playSecondWarning");
                }
                else
                {
                    await JSRuntime.InvokeVoidAsync("AudioAlerts.playFirstWarning");
                }
                
                // Visuelles Feedback
                StateHasChanged();
                
                // Optional: Toast-Notification
                if (isSecondWarning)
                {
                    ToastService.ShowError($"?? KRITISCHE WARNUNG: {team.TeamName} - {team.SecondWarningMinutes} Minuten erreicht!");
                }
                else
                {
                    ToastService.ShowWarning($"?? WARNUNG: {team.TeamName} - {team.FirstWarningMinutes} Minuten erreicht!");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Fehler beim Abspielen der Warnung: {ex.Message}");
            }
        });
    }

    private void GoToMap()
    {
        Navigation.NavigateTo("/einsatz/karte");
    }

    private void GoToReport()
    {
        Navigation.NavigateTo("/einsatz/bericht");
    }

    private void ShowEndEinsatzDialog()
    {
        _endZeit = TimeOnly.FromDateTime(DateTime.Now);
        _endErgebnis = "";
        _endBemerkungen = "";
        _showEndDialog = true;
    }

    private void CloseEndEinsatzDialog()
    {
        _showEndDialog = false;
    }

    private async Task EndEinsatzConfirmed()
    {
        try
        {
            // Setze die Einsatz-Ende Zeit
            var endDateTime = EinsatzService.CurrentEinsatz.EinsatzDatum.Date.Add(_endZeit.ToTimeSpan());
            EinsatzService.CurrentEinsatz.EinsatzEnde = endDateTime;
            
            // Archiviere den Einsatz
            var archived = await ArchivService.ArchiveEinsatzAsync(
                EinsatzService.CurrentEinsatz, 
                _endErgebnis, 
                _endBemerkungen);
            
            ToastService.ShowSuccess("Einsatz wurde erfolgreich archiviert.");
            
            // Reset EinsatzService (Teams und Notizen loeschen)
            EinsatzService.ResetEinsatz();
            
            _showEndDialog = false;
            
            // Zur Archiv-Seite navigieren
            Navigation.NavigateTo($"/archiv/{archived.Id}");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Fehler beim Archivieren: {ex.Message}");
        }
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
        
        EinsatzService.TeamAdded -= OnDataChanged;
        EinsatzService.TeamRemoved -= OnDataChanged;
        EinsatzService.TeamUpdated -= OnDataChanged;
        EinsatzService.NoteAdded -= OnDataChanged;
        EinsatzService.TeamWarningTriggered -= OnWarningTriggered;
        EinsatzService.EinsatzChanged -= OnEinsatzChanged;

        foreach (var team in _teams)
        {
            team.TimerTick -= OnTimerTick;
        }
    }
    
    private void OnEinsatzChanged()
    {
        InvokeAsync(StateHasChanged);
    }
}
